# ptd-tool

A tool for dealing with PTD related data files.
Currently it can decode

* MD (stands for Master Data?) files
* server responses captured with MITM http proxy tools like Burp suite, mitmproxy, etc.
* Some of save data files in `SaveData` directory. Files with name starting with numbers cannot currently be decoded. pa.ds is a plain BSON file that keeps truck of downloaded asset bundles1.

Encoding is only supported for save data files.
Also, login response can be generated using decoded MD data.

Response/MD decryption code is based on esterTion's work here. 

https://estertion.win/2019/03/project-tokyo-dolls-%E6%8B%86%E8%A7%A3%E7%9B%B8%E5%85%B3/

I rewrote the tool in go and added many other features described above.
For response decoding, I added a feature to decode responses after logging in.
I also fixed issues with string fields of MD, which causes decoded strings and subsequent entries to be corrupted.

Currently requests cannot be decoded.

## Building

go 1.16 or higher is required.

```
go build
```

Or you could use `go run .` to compile and run with single command.

## Usage

Most of subcommands writes result to standard output. Format with jq or your favorite text editor to get formatted output.

### Decoding responses

You don't need to give shared key to decode GetNativeToken/Login response. Just throw in json captured with the tool.

```
./ptd-tool decode-response Login-input.json > Login.json
```

For other responses, you need to give `--shared-security-key`. The game uses a key unique to each user, to encrypt all requests and responses between your device and server. You can find it in one of responses from sqex-bridge server.
The key file must be exactly 32 bytes in length.

```
./ptd-tool decode-response GetServerTime-input.json --shared-security-key shared-security-key.txt > Login.json
```

### Decoding/Encoding local save data

Local save data always uses embedded key for encoding/decoding so you don't need to prepare one.

Decoding:

```
./ptd-tool decode-save-data ./OrigSaveData/oiou_0.ds > ./DecodedSaveData/oiou_0.json
```

Encoding:

```
./ptd-tool encode-save-data ./DecodedSaveData/oiou_0.json > ./SaveData/oiou_0.ds
```

### Decoding MD

You need to have copy of md directory created by the app on your computer.
Replace `/path/to/md-dir` with actual md directory path.

```
./ptd-tool decode-md /path/to/md-dir/MD_Avatar.snd --config ./assets/md_loader_configs/MD_Avatar_config.json > MD_Avatar.json
```

`./assets/md_loader_configs/` contains configs needed for decoding some MD files.

### Creating new config file

I wrote config files in assets/md_loader_configs manually.  I didn't wrote them for all types of MD, just because I'm not interested in reading all of them.
It should not be very hard to create new one manually. The method I described below uses `dump.cs` generated by Il2CppDumper as the source of config file.

Take `MD_CharacterMemoryLock.json` as an example.

```cs
// Namespace: 
public sealed class MD_CharacterMemoryLock : SBFData.ISerializeData, SBFData.DataID // TypeDefIndex: 8879
{
	// Fields
	private string _ID; // 0x8
	private string _Name; // 0xC
	private string _Detail; // 0x10
	private string _KeyID; // 0x14
	private string _CommuID; // 0x18

    // ... other fields and properties
}
```

1. remove unrelated lines and tabs

```cs
private string _ID; // 0x8
private string _Name; // 0xC
private string _Detail; // 0x10
private string _KeyID; // 0x14
private string _CommuID; // 0x18
```

2. run Find and replace in your favorite text editor with the following regular expression.

```
private ([^ \r\n]+) (.+);.*
{"type":"$1","name":"$2", "include": true},
```

3. Remove last `,` and surround lines with `{"fields": [` and `]}`. Then format JSON with the editor.

4. (Optional) Remove `"include": true` line from config JSON to exclude some of fields from output JSON.

5. Run the following command to get decoded MD as JSON.

```
./ptd-tool decode-md /mnt/d/tmp/md/MD_CharacterMemoryLock.snd --config ./assets/md_loader_configs/MD_CharacterMemoryLock_config.json | jq > ./out/md/MD_CharacterMemoryLock.json
```

Note that some types of MD might have more than one snd files that can be decoded with single config file.
You may end up doing reverse engineer anyway if you can't guess combination of snd flies... but we were able to find most of combinations just by guessing.

### addIndex option

For `MD_Weapon_config.json` and `MD_Costume_config.json`, `addIndex` option is enabled to help you in finding cards/weapons easily in gallery mode (カード図鑑, 武器図鑑). This will add `index` field to each array element for finding cards/weapons by their number.

### Generating Login response

First, decode MD files with the following script first to generate required JSON files.
Replace `/path/to/md-dir` with actual md directory path.

```
MD_SRC_DIR=/path/to/md-dir/md MD_DEST_DIR=./out/md/ ./generate-md-assets.sh
```

Then generate response with this command. Don't send json formatted with jq to the device if you want to use it with ptd-hook. The app only accepts minified JSON, and does not accept formatted JSON.

You can optionally change costumes, weapons, classes etc of generated response by specifying a different config file.

```
./ptd-tool generate-login-response --decoded-md-dir ./out/md/ --config ./assets/login-response-generator-config.json > Login.json
```
